---
title: "Simple SIR data simulation"
author: "Breck Baldwin"
date:  '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo = TRUE, message = FALSE, comment = NA, include = TRUE)
```

# Navigation

This Rmarkdown page exists as part of the [CoDatMo](https://codatmo.github.io/) project. The repo containing this page is at [https://github.com/codatmo/dataGeneratingProcess1](https://github.com/codatmo/dataGeneratingProcess) as 'index.Rmd' and rendered as 'index.html'. 

# Model 1

About the simplest SIR model I can think of. Surprisingly error prone process and very sensitive to infection rate. See below. I find it very useful to naively code up a simulation for some problem I am trying to model. I am not an epidemiologist and have no medical training. 

I have looked at some infection models so this is not totally naive, see [https://mc-stan.org/users/documentation/case-studies/boarding_school_case_study.html](https://mc-stan.org/users/documentation/case-studies/boarding_school_case_study.html) which I found to be a good explanation. I have not attempted to reproduce that model here although there is a model reproduction check list I did at [https://codatmo.github.io/Simple_SIR/](https://codatmo.github.io/Simple_SIR/). 

I don't use standard terms like R0, Rt etc because there are subtleties that I am not sure will get right and wanting to keep things naive. 

There are likely gross errors which please point out in the issue tracker or send me email. 

```{r}
rm(list = ls()) #clean out the cruft

set.seed(43614)
runModel1 = function(runName = runName,
                     nPop = nPop,
                     nDays = nDays,
                     print = PRINT,
                     probInfectPerContact = probInfectPerContact) {
  dayState = c('i', rep('s', nPop - 1))
  infectionDay = c(1, rep(NA, nPop - 1))
  
  meanDaysInfectious = 3
  meanContactsPerDay = 10
  
  #dataM = matrix(nrow = nDays, ncol = 3)
  colNames = c('runName', 'day', 's', 'i', 'r', 'probInfectPerContact')
  df = data.frame(matrix(nrow = 0, ncol=length(colNames)))
  colnames(df) = colNames
  nextDayState = dayState
  for (d in 1:nDays) {
    df[d,] = rep(NA,length(colNames)) #setup data, will cause errors if I miss something
    df[d,]$runName = runName
    df[d,]$s=  length(subset(dayState, dayState == 's'))
    df[d,]$i = length(subset(dayState, dayState == 'i'))
    df[d,]$r = length(subset(dayState, dayState == 'r'))
    df[d,]$day = d
    df[d,]$probInfectPerContact = probInfectPerContact
    #dataM[d,] = c(susceptible, infectious, resolved)
    if (print) {
      cat(
        sprintf(
          "Day=%d, susceptible=%d, infected=%d, resolved=%d\n",
           df[d,]$day, df[d,]$s, df[d,]$i, df[d,]$r))
    }
    for (per in 1:nPop) {
      #end infectious period
      if (dayState[per] == 'i') {
        if (d - infectionDay[per]  > meanDaysInfectious) {
          nextDayState[per] = 'r'
        }
      }
    }
    for (per in 1:nPop) {
      if (dayState[per] == 'i') {
        for (otherPer in sample(1:nPop, meanContactsPerDay)) {
          if (dayState[otherPer] == 's' &&
              rbinom(1, 1, probInfectPerContact) == 1) {
            nextDayState[otherPer] = 'i'
            infectionDay[otherPer] = d
          }
        }
      }
    }
    dayState = nextDayState
  }
  return(df)
}

dataM = runModel1(runName = "1/30", nPop = 1e+04, nDays = 100, print = TRUE, probInfectPerContact = 1/30)

```

Running this showed lots of sensitivity around 1/31 to 1/33 infection rate. 

Thought I should graph it, see below, this is for the 'i' state or infectious. 


```{r}
library(tidyverse)
library(ggplot2)

df = data.frame()
for (i in 20:34) {
  df2 = runModel1(runName = sprintf("1/%d=%.3f", i, 1/i), nPop = 1e+04, 
                    nDays = 100, print = FALSE, probInfectPerContact = 1/i)  
  df = rbind(df,df2)
}

dfLong = gather(df, key = sir, value = count, c(s, i, r))

plot = ggplot(data = dfLong[dfLong$sir == 'i',], 
              aes(x = day, y = count, group = runName, color = runName)) +
  geom_line()


print(plot)
```


Above are varying rates of probability of infection per contact for a population of 10,000 for 100 days for the 'i' or infected state. Whether patient-zero manages to infect someone is a big issue, real world probably like this too. 

```{r}
nDays = 100
nPop = 1e+04
dataM = runModel1(runName = "1/30", nPop = nPop, nDays = nDays, print = TRUE, 
                  probInfectPerContact = 1/30)
```

```{r echo=TRUE}
library("cmdstanr")

# Run from command line: Rscript run.R
# If running from RStudio remember to set the working directory
# >Session>Set Working Directory>To Source File Location

model <- cmdstan_model("stan/sir_negbin.stan")

stan_data <- list(n_days = nrow(dataM), y0 = c(nPop -1, 1, 0), t0 = 0, 
                  ts = 1:nDays, N = nPop, cases = dataM$i, compute_likelihood = 1)

fit <- model$sample(data=stan_data, output_dir="output", num_cores = 4, 
                    num_chains = 4)
print(fit$summary(variables = c('pred_cases')))
```